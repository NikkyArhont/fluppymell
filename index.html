<script>
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
const diag = document.getElementById('diag');
resize();
window.addEventListener('resize', resize, { passive: true });

let bird = { x: 100, y: 250, vy: 0, size: 20, gravity: 0.5, lift: -8 };
let pipes = [];
let items = [];
let score = 0;
let best = 0;
let gameOver = false;
let shield = false;
let lastTime = performance.now();

// ÐŸÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð´Ð»Ñ Ñ‚Ð°Ð¹Ð¼Ð¸Ð½Ð³Ð° ÑÐ¿Ð°ÑƒÐ½Ð°, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¾Ð½ Ð·Ð°Ð²Ð¸ÑÐµÐ» Ð¾Ñ‚ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸, Ð° Ð½Ðµ Ð¾Ñ‚ ÐºÐ°Ð´Ñ€Ð¾Ð²
let pipeSpawnTimer = 0;
const PIPE_SPAWN_INTERVAL = 100 * 16.67; // Ð˜Ð½Ñ‚ÐµÑ€Ð²Ð°Ð» Ð² Ð¼Ñ (100 ÐºÐ°Ð´Ñ€Ð¾Ð² * ~16.67 Ð¼Ñ/ÐºÐ°Ð´Ñ€)
let itemSpawnTimer = 0;
const ITEM_SPAWN_INTERVAL = 200 * 16.67; // Ð˜Ð½Ñ‚ÐµÑ€Ð²Ð°Ð» Ð² Ð¼Ñ (200 ÐºÐ°Ð´Ñ€Ð¾Ð² * ~16.67 Ð¼Ñ/ÐºÐ°Ð´Ñ€)

const imgHero = new Image();
imgHero.crossOrigin = 'anonymous';
let heroReady = false;
let heroBroken = false;
imgHero.onload = () => { heroReady = true; };
imgHero.onerror = () => { heroBroken = true; };
imgHero.src = 'hero.png';

const sndJumpÂ  = new Audio('jump.mp3');
const sndWallÂ  = new Audio('wall.mp3');
const sndBombÂ  = new Audio('bomb.mp3');
const sndMoney = new Audio('money.mp3');
const sndHeart = new Audio('heart.mp3');

function resize() {
Â  canvas.width = window.innerWidth;
Â  canvas.height = window.innerHeight;
}

function drawCharacter() {
Â  const b = bird;
Â  ctx.save();
Â  ctx.translate(b.x, b.y);
Â  // Ð£Ð³Ð¾Ð» Ð¿Ð¾Ð²Ð¾Ñ€Ð¾Ñ‚Ð° Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ ÑÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð±Ñ‹Ñ‚ÑŒ Ð½ÐµÐ·Ð°Ð²Ð¸ÑÐ¸Ð¼Ñ‹Ð¼ Ð¾Ñ‚ dt,
Â  // Ð¸Ð»Ð¸ Ð¶Ðµ Ð½ÑƒÐ¶Ð½Ð¾ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ Ð¿Ð¾ÑÑ‚Ð¾ÑÐ½Ð½Ñ‹Ð¹ ÐºÐ¾ÑÑ„Ñ„Ð¸Ñ†Ð¸ÐµÐ½Ñ‚ Ð´Ð»Ñ Ð²Ð¸Ð·ÑƒÐ°Ð»ÑŒÐ½Ð¾Ð³Ð¾ ÑÑ„Ñ„ÐµÐºÑ‚Ð°.
Â  ctx.rotate(b.vy / 15);
Â  const size = b.size * 2;
Â  if (!heroBroken && heroReady && imgHero.complete && imgHero.naturalWidth > 0) {
Â  Â  try { ctx.drawImage(imgHero, -size, -size, size * 2, size * 2); }
Â  Â  catch { drawFallbackAvatar(); }
Â  } else drawFallbackAvatar();
Â  ctx.restore();
}

function drawFallbackAvatar(){
Â  const b = bird;
Â  ctx.fillStyle = '#f2d2b6';
Â  ctx.beginPath(); ctx.arc(0, 0, b.size, 0, Math.PI*2); ctx.fill();
Â  ctx.fillStyle = '#d770ff';
Â  ctx.beginPath(); ctx.arc(0, -b.size*0.7, b.size*1.1, Math.PI, 0); ctx.fill();
}

function drawPipes() {
Â  ctx.fillStyle = '#2ecc71';
Â  pipes.forEach(p => {
Â  Â  ctx.fillRect(p.x, 0, 60, p.top);
Â  Â  ctx.fillRect(p.x, p.top + p.gap, 60, canvas.height);
Â  });
}

function drawItems() {
Â  ctx.font = '30px system-ui';
Â  ctx.textBaseline = 'middle';
Â  ctx.textAlign = 'center';
Â  items.forEach(it => ctx.fillText(it.icon, it.x, it.y));
}

// ----------------------------------------------------
// Ð“Ð»Ð°Ð²Ð½Ð°Ñ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ñ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ, Ð·Ð°Ð²Ð¸ÑÑÑ‰Ð°Ñ Ð¾Ñ‚ Ð´ÐµÐ»ÑŒÑ‚Ð°-Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸
// ----------------------------------------------------
function update(dt_ms) {
Â  if (gameOver) return;

Â  // ÐšÐ¾Ð½ÑÑ‚Ð°Ð½Ñ‚Ð°, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð½Ð¾Ñ€Ð¼Ð°Ð»Ð¸Ð·Ð¾Ð²Ð°Ñ‚ÑŒ Ð²ÑÐµ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹ Ðº ÑÑ‚Ð°Ð»Ð¾Ð½Ð½Ñ‹Ð¼ 60 FPS (16.67 Ð¼Ñ)
Â  const dt_norm = dt_ms / 16.67; 
Â  
Â  // Ð¤Ð¸Ð·Ð¸ÐºÐ° Ð¿Ñ‚Ð¸Ñ†Ñ‹
Â  // Ð¡ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð³Ñ€Ð°Ð²Ð¸Ñ‚Ð°Ñ†Ð¸ÑŽ Ð¸ Ð¿ÐµÑ€ÐµÐ¼ÐµÑ‰ÐµÐ½Ð¸Ðµ Ð½Ð° dt_norm
Â  bird.vy += bird.gravity * dt_norm;
Â  bird.y += bird.vy * dt_norm;
Â  
Â  if (bird.y + bird.size > canvas.height || bird.y - bird.size < 0) { play(sndWall); endGame(); }

Â  // --- Ð¡Ð¿Ð°ÑƒÐ½ Ñ‚Ñ€ÑƒÐ± (Ð·Ð°Ð²Ð¸ÑÐ¸Ñ‚ Ð¾Ñ‚ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸) ---
Â  pipeSpawnTimer += dt_ms;
Â  if (pipeSpawnTimer >= PIPE_SPAWN_INTERVAL) {
Â  Â  pipeSpawnTimer -= PIPE_SPAWN_INTERVAL;
Â  Â  const top = Math.random() * (canvas.height / 2);
Â  Â  pipes.push({ x: canvas.width, top, gap: 190, passed: false });
Â  }

Â  // --- Ð¡Ð¿Ð°ÑƒÐ½ Ð±Ð¾Ð½ÑƒÑÐ¾Ð² (Ð·Ð°Ð²Ð¸ÑÐ¸Ñ‚ Ð¾Ñ‚ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸) ---
Â  itemSpawnTimer += dt_ms;
Â  if (itemSpawnTimer >= ITEM_SPAWN_INTERVAL) {
Â  Â  itemSpawnTimer -= ITEM_SPAWN_INTERVAL;
Â  Â  const roll = Math.random();
Â  Â  let type;
Â  Â  if (roll < 0.4) type = 'â¤ï¸';
Â  Â  else if (roll < 0.8) type = 'ðŸ’µ';
Â  Â  else type = 'ðŸ’£';

Â  Â  let x = canvas.width + 140;
Â  Â  let y;
Â  Â  if (pipes.length) {
Â  Â  Â  const last = pipes[pipes.length - 1];
Â  Â  Â  const gapCenter = last.top + last.gap / 2;
Â  Â  Â  const safeMargin = 50;
Â  Â  Â  const minY = Math.max(60, gapCenter - last.gap / 2 + safeMargin);
Â  Â  Â  const maxY = Math.min(canvas.height - 80, gapCenter + last.gap / 2 - safeMargin);
Â  Â  Â  y = rnd(minY, maxY);
Â  Â  } else {
Â  Â  Â  y = rnd(100, canvas.height - 180);
Â  Â  }
Â  Â  items.push({ x, y, icon: type, type, collected: false });
Â  }
Â  
Â  // Ð”Ð²Ð¸Ð¶ÐµÐ½Ð¸Ðµ Ñ‚Ñ€ÑƒÐ± Ð¸ Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚Ð¾Ð²
Â  const pipeSpeed = 3.2 * dt_norm;
Â  pipes.forEach(p => (p.x -= pipeSpeed));
Â  items.forEach(i => (i.x -= pipeSpeed));
Â  
Â  pipes = pipes.filter(p => p.x > -70);
Â  items = items.filter(i => i.x > -40 && !i.collected);

Â  // ÐšÐ¾Ð»Ð»Ð¸Ð·Ð¸Ð¸
Â  pipes.forEach(p => {
Â  Â  const center = p.x + 30;
Â  Â  if (!p.passed && center < bird.x) { p.passed = true; score++; }
Â  Â  if (bird.x + bird.size > p.x && bird.x - bird.size < p.x + 60) {
Â  Â  Â  if (bird.y - bird.size < p.top || bird.y + bird.size > p.top + p.gap) {
Â  Â  Â  Â  if (shield) shield = false; else { play(sndWall); endGame(); }
Â  Â  Â  }
Â  Â  }
Â  });

Â  items.forEach(i => {
Â  Â  if (Math.abs(bird.x - i.x) < bird.size && Math.abs(bird.y - i.y) < bird.size) {
Â  Â  Â  if (i.type === 'ðŸ’£') { play(sndBomb); endGame(); }
Â  Â  Â  if (i.type === 'ðŸ’µ') { play(sndMoney); score += 3; }
Â  Â  Â  if (i.type === 'â¤ï¸') { play(sndHeart); shield = true; }
Â  Â  Â  i.collected = true;
Â  Â  }
Â  });
}
// ----------------------------------------------------

function drawHUD() {
Â  ctx.fillStyle = '#000';
Â  ctx.globalAlpha = 0.25; ctx.fillRect(10, 10, 180, 60); ctx.globalAlpha = 1;
Â  ctx.fillStyle = '#fff';
Â  ctx.font = '20px system-ui';
Â  ctx.textAlign = 'left'; ctx.textBaseline = 'alphabetic';
Â  ctx.fillText(`ÐžÑ‡ÐºÐ¸: ${score}`, 20, 40);
Â  ctx.fillText(`Ð›ÑƒÑ‡ÑˆÐ¸Ð¹: ${best}`, 20, 65);
Â  if (shield) {
Â  Â  ctx.strokeStyle = 'rgba(255,0,0,0.5)';
Â  Â  ctx.lineWidth = 3; ctx.beginPath(); ctx.arc(bird.x, bird.y, bird.size * 1.5, 0, Math.PI * 2); ctx.stroke();
Â  }
}

function draw() {
Â  ctx.clearRect(0, 0, canvas.width, canvas.height);
Â  drawPipes();
Â  drawItems();
Â  drawCharacter();
Â  drawHUD();
Â  if (gameOver) {
Â  Â  ctx.fillStyle = 'rgba(0,0,0,0.6)';
Â  Â  const w = Math.min(380, canvas.width - 40);
Â  Â  const x = (canvas.width - w) / 2;
Â  Â  const y = canvas.height / 2 - 80;
Â  Â  ctx.fillRect(x, y, w, 160);
Â  Â  ctx.fillStyle = '#fff';
Â  Â  ctx.font = '28px system-ui';
Â  Â  ctx.textAlign = 'center';
Â  Â  ctx.fillText('Ð˜Ð³Ñ€Ð° Ð¾ÐºÐ¾Ð½Ñ‡ÐµÐ½Ð°', canvas.width / 2, y + 56);
Â  Â  ctx.font = '18px system-ui';
Â  Â  ctx.fillText('ÐÐ°Ð¶Ð¼Ð¸ Ð´Ð»Ñ Ñ€ÐµÑÑ‚Ð°Ñ€Ñ‚Ð°', canvas.width / 2, y + 100);
Â  }
}

function endGame() { gameOver = true; best = Math.max(best, score); }

// ----------------------------------------------------
// Ð“Ð»Ð°Ð²Ð½Ñ‹Ð¹ Ð¸Ð³Ñ€Ð¾Ð²Ð¾Ð¹ Ñ†Ð¸ÐºÐ» Ñ Ñ€Ð°ÑÑ‡ÐµÑ‚Ð¾Ð¼ Ð´ÐµÐ»ÑŒÑ‚Ð°-Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸
// ----------------------------------------------------
function loop() {
Â  const now = performance.now();
Â  // Ð”ÐµÐ»ÑŒÑ‚Ð°-Ð²Ñ€ÐµÐ¼Ñ Ð² Ð¼Ð¸Ð»Ð»Ð¸ÑÐµÐºÑƒÐ½Ð´Ð°Ñ…
Â  const dt_ms = now - lastTime; 
Â  lastTime = now;

Â  // ÐžÐ³Ñ€Ð°Ð½Ð¸Ñ‡Ð¸Ð²Ð°ÐµÐ¼ dt, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¸Ð·Ð±ÐµÐ¶Ð°Ñ‚ÑŒ ÑÐ±Ð¾ÐµÐ² Ð¿Ñ€Ð¸ Ð¿ÐµÑ€ÐµÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ð¸ Ð²ÐºÐ»Ð°Ð´Ð¾Ðº
Â  if (dt_ms < 1000) { 
Â  Â  update(dt_ms); 
Â  } else {
Â  Â  // Ð¡Ð±Ñ€Ð¾Ñ Ñ‚Ð°Ð¹Ð¼ÐµÑ€Ð¾Ð², ÐµÑÐ»Ð¸ Ð²ÐºÐ»Ð°Ð´ÐºÐ° Ð±Ñ‹Ð»Ð° Ð½ÐµÐ°ÐºÑ‚Ð¸Ð²Ð½Ð° Ð´Ð¾Ð»Ð³Ð¾Ðµ Ð²Ñ€ÐµÐ¼Ñ
Â  Â  pipeSpawnTimer = 0;
Â  Â  itemSpawnTimer = 0;
Â  }
Â  
Â  draw();
Â  requestAnimationFrame(loop);
}
// ----------------------------------------------------

let interacted = false;
function primeAudio() {
Â  if (!interacted) { [sndJump,sndWall,sndBomb,sndMoney,sndHeart].forEach(s=>{ try{ s.play().then(()=>s.pause()).catch(()=>{}); }catch(_){} }); interacted = true; }
}

function play(snd){ if (interacted) { try { snd.currentTime = 0; snd.play(); } catch(_){} } }

function flap() {
Â  primeAudio();
Â  if (gameOver) {
Â  Â  gameOver = false; pipes = []; items = []; score = 0; bird.y = canvas.height * 0.5; bird.vy = 0; shield = false; 
Â  Â  // Ð¡Ð±Ñ€Ð¾Ñ Ñ‚Ð°Ð¹Ð¼ÐµÑ€Ð¾Ð² ÑÐ¿Ð°ÑƒÐ½Ð° Ð¿Ñ€Ð¸ Ñ€ÐµÑÑ‚Ð°Ñ€Ñ‚Ðµ
Â  Â  pipeSpawnTimer = 0; itemSpawnTimer = 0; 
Â  Â  lastTime = performance.now(); // Ð¡Ð±Ñ€Ð¾Ñ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¸Ð·Ð±ÐµÐ¶Ð°Ñ‚ÑŒ Ð±Ð¾Ð»ÑŒÑˆÐ¾Ð³Ð¾ dt Ð² Ð¿ÐµÑ€Ð²Ð¾Ð¼ ÐºÐ°Ð´Ñ€Ðµ
Â  Â  return;
Â  }
Â  play(sndJump);
Â  // Lift Ñ‚Ð°ÐºÐ¶Ðµ Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ ÑÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð±Ñ‹Ñ‚ÑŒ Ð½ÐµÐ·Ð°Ð²Ð¸ÑÐ¸Ð¼Ñ‹Ð¼ Ð¾Ñ‚ dt, 
Â  // Ð¸Ð»Ð¸ Ð¶Ðµ Ð¿Ñ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ð½Ñ‹Ð¼, ÐºÐ°Ðº Ð¸ Ð³Ñ€Ð°Ð²Ð¸Ñ‚Ð°Ñ†Ð¸Ñ. Ð”Ð»Ñ Flappy Bird Ð¿Ñ€Ð¾Ñ‰Ðµ Ð¾ÑÑ‚Ð°Ð²Ð¸Ñ‚ÑŒ ÐºÐ¾Ð½ÑÑ‚Ð°Ð½Ñ‚Ð¾Ð¹.
Â  bird.vy = bird.lift; 
}
canvas.addEventListener('mousedown', flap);
canvas.addEventListener('touchstart', (e)=>{ e.preventDefault(); flap(); }, { passive:false });
window.addEventListener('keydown', (e)=>{ if (e.code === 'Space' || e.code === 'ArrowUp') { e.preventDefault(); flap(); } });

function rnd(min, max){ return Math.random() * (max - min) + min; }

loop();
</script>
