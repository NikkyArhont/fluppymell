<script>
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
const diag = document.getElementById('diag');
resize();
window.addEventListener('resize', resize, { passive: true });

let bird = { x: 100, y: 250, vy: 0, size: 20, gravity: 0.5, lift: -8 };
let pipes = [];
let items = [];
let score = 0;
let best = 0;
let gameOver = false;
let shield = false;
let lastTime = performance.now();

// ĞŸĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ Ğ´Ğ»Ñ Ñ‚Ğ°Ğ¹Ğ¼Ğ¸Ğ½Ğ³Ğ° ÑĞ¿Ğ°ÑƒĞ½Ğ°, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¾Ğ½ Ğ·Ğ°Ğ²Ğ¸ÑĞµĞ» Ğ¾Ñ‚ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸, Ğ° Ğ½Ğµ Ğ¾Ñ‚ ĞºĞ°Ğ´Ñ€Ğ¾Ğ²
let pipeSpawnTimer = 0;
// Ğ˜Ğ½Ñ‚ĞµÑ€Ğ²Ğ°Ğ» Ğ² Ğ¼Ñ (100 "ÑÑ‚Ğ°Ñ€Ñ‹Ñ… ĞºĞ°Ğ´Ñ€Ğ¾Ğ²" * 16.67Ğ¼Ñ/ĞºĞ°Ğ´Ñ€ â‰ˆ 1.67 ÑĞµĞºÑƒĞ½Ğ´Ñ‹)
const PIPE_SPAWN_INTERVAL = 100 * 16.67; 
let itemSpawnTimer = 0;
// Ğ˜Ğ½Ñ‚ĞµÑ€Ğ²Ğ°Ğ» Ğ² Ğ¼Ñ (200 "ÑÑ‚Ğ°Ñ€Ñ‹Ñ… ĞºĞ°Ğ´Ñ€Ğ¾Ğ²" * 16.67Ğ¼Ñ/ĞºĞ°Ğ´Ñ€ â‰ˆ 3.33 ÑĞµĞºÑƒĞ½Ğ´Ñ‹)
const ITEM_SPAWN_INTERVAL = 200 * 16.67; 
Â Â 
const imgHero = new Image();
imgHero.crossOrigin = 'anonymous';
let heroReady = false;
let heroBroken = false;
imgHero.onload = () => { heroReady = true; };
imgHero.onerror = () => { heroBroken = true; };
imgHero.src = 'hero.png';

const sndJumpÂ  = new Audio('jump.mp3');
const sndWallÂ  = new Audio('wall.mp3');
const sndBombÂ  = new Audio('bomb.mp3');
const sndMoney = new Audio('money.mp3');
const sndHeart = new Audio('heart.mp3');

function resize() {
Â  canvas.width = window.innerWidth;
Â  canvas.height = window.innerHeight;
}

function drawCharacter() {
Â  const b = bird;
Â  ctx.save();
Â  ctx.translate(b.x, b.y);
  // ĞŸĞ¾Ğ²Ğ¾Ñ€Ğ¾Ñ‚ Ğ¿Ñ‚Ğ¸Ñ†Ñ‹ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ñ‚ Ğ¾Ñ‚ ĞµĞµ Ğ²ĞµÑ€Ñ‚Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ğ¾Ğ¹ ÑĞºĞ¾Ñ€Ğ¾ÑÑ‚Ğ¸
Â  ctx.rotate(b.vy / 15); 
Â  const size = b.size * 2;
Â  if (!heroBroken && heroReady && imgHero.complete && imgHero.naturalWidth > 0) {
Â  Â  try { ctx.drawImage(imgHero, -size, -size, size * 2, size * 2); }
Â  Â  catch { drawFallbackAvatar(); }
Â  } else drawFallbackAvatar();
Â  ctx.restore();
}

function drawFallbackAvatar(){
Â  const b = bird;
Â  ctx.fillStyle = '#f2d2b6';
Â  ctx.beginPath(); ctx.arc(0, 0, b.size, 0, Math.PI*2); ctx.fill();
Â  ctx.fillStyle = '#d770ff';
Â  ctx.beginPath(); ctx.arc(0, -b.size*0.7, b.size*1.1, Math.PI, 0); ctx.fill();
}

function drawPipes() {
Â  ctx.fillStyle = '#2ecc71';
Â  pipes.forEach(p => {
Â  Â  ctx.fillRect(p.x, 0, 60, p.top);
Â  Â  ctx.fillRect(p.x, p.top + p.gap, 60, canvas.height);
Â  });
}

function drawItems() {
Â  ctx.font = '30px system-ui';
Â  ctx.textBaseline = 'middle';
Â  ctx.textAlign = 'center';
Â  items.forEach(it => ctx.fillText(it.icon, it.x, it.y));
}

// ----------------------------------------------------
// Ğ“Ğ»Ğ°Ğ²Ğ½Ğ°Ñ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ, Ğ·Ğ°Ğ²Ğ¸ÑÑÑ‰Ğ°Ñ Ğ¾Ñ‚ Ğ´ĞµĞ»ÑŒÑ‚Ğ°-Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸
// ----------------------------------------------------
function update(dt_ms) {
Â  if (gameOver) return;

  // dt_norm = 1.0, ĞµÑĞ»Ğ¸ Ğ¿Ñ€Ğ¾ÑˆĞ»Ğ¾ 16.67Ğ¼Ñ (60 FPS)
  // dt_norm = 2.0, ĞµÑĞ»Ğ¸ Ğ¿Ñ€Ğ¾ÑˆĞ»Ğ¾ 33.34Ğ¼Ñ (30 FPS)
Â  const dt_norm = dt_ms / 16.67; 
Â  
Â  // Ğ¤Ğ¸Ğ·Ğ¸ĞºĞ° Ğ¿Ñ‚Ğ¸Ñ†Ñ‹:
  // Ğ’ÑĞµ Ğ´Ğ²Ğ¸Ğ¶ĞµĞ½Ğ¸Ñ (Ğ³Ñ€Ğ°Ğ²Ğ¸Ñ‚Ğ°Ñ†Ğ¸Ñ, ÑĞºĞ¾Ñ€Ğ¾ÑÑ‚ÑŒ) ÑƒĞ¼Ğ½Ğ¾Ğ¶Ğ°ÑÑ‚ÑÑ Ğ½Ğ° dt_norm,
  // Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¿Ñ‚Ğ¸Ñ†Ğ° Ğ¿Ğ°Ğ´Ğ°Ğ»Ğ° Ñ Ğ¾Ğ´Ğ¸Ğ½Ğ°ĞºĞ¾Ğ²Ğ¾Ğ¹ *ÑĞºĞ¾Ñ€Ğ¾ÑÑ‚ÑŒÑ* (Ğ° Ğ½Ğµ Ğ½Ğ° Ğ¾Ğ´Ğ¸Ğ½Ğ°ĞºĞ¾Ğ²Ñ‹Ğµ Ğ¿Ğ¸ĞºÑĞµĞ»Ğ¸ Ğ·Ğ° ĞºĞ°Ğ´Ñ€)
Â  bird.vy += bird.gravity * dt_norm;
Â  bird.y += bird.vy * dt_norm;
Â  
Â  if (bird.y + bird.size > canvas.height || bird.y - bird.size < 0) { play(sndWall); endGame(); }

Â  // --- Ğ¡Ğ¿Ğ°ÑƒĞ½ Ñ‚Ñ€ÑƒĞ± (Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ñ‚ Ğ¾Ñ‚ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸, Ğ° Ğ½Ğµ Ğ¾Ñ‚ ĞºĞ°Ğ´Ñ€Ğ¾Ğ²) ---
Â  pipeSpawnTimer += dt_ms;
Â  if (pipeSpawnTimer >= PIPE_SPAWN_INTERVAL) {
    // Ğ¡Ğ±Ñ€Ğ°ÑÑ‹Ğ²Ğ°ĞµĞ¼ Ñ‚Ğ°Ğ¹Ğ¼ĞµÑ€ (Ğ²Ñ‹Ñ‡Ğ¸Ñ‚Ğ°ĞµĞ¼ Ğ¸Ğ½Ñ‚ĞµÑ€Ğ²Ğ°Ğ», Ğ° Ğ½Ğµ Ğ¾Ğ±Ğ½ÑƒĞ»ÑĞµĞ¼,
    // Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ½Ğµ Ñ‚ĞµÑ€ÑÑ‚ÑŒ "Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ğº" Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸)
Â  Â  pipeSpawnTimer -= PIPE_SPAWN_INTERVAL; 
Â  Â  const top = Math.random() * (canvas.height / 2);
Â  Â  pipes.push({ x: canvas.width, top, gap: 190, passed: false });
Â  }

Â  // --- Ğ¡Ğ¿Ğ°ÑƒĞ½ Ğ±Ğ¾Ğ½ÑƒÑĞ¾Ğ² (Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ñ‚ Ğ¾Ñ‚ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸) ---
Â  itemSpawnTimer += dt_ms;
Â  if (itemSpawnTimer >= ITEM_SPAWN_INTERVAL) {
Â  Â  itemSpawnTimer -= ITEM_SPAWN_INTERVAL;
Â  Â  const roll = Math.random();
Â  Â  let type;
Â  Â  if (roll < 0.4) type = 'â¤ï¸'; // Ñ‡Ğ°Ñ‰Ğµ ÑĞµÑ€Ğ´Ñ†Ğ°
Â  Â  else if (roll < 0.8) type = 'ğŸ’µ'; // Ñ‡Ğ°Ñ‰Ğµ Ğ´ĞµĞ½ÑŒĞ³Ğ¸
Â  Â  else type = 'ğŸ’£';

Â  Â  let x = canvas.width + 140;
Â  Â  let y;
Â  Â  if (pipes.length) {
Â  Â  Â  const last = pipes[pipes.length - 1];
Â  Â  Â  const gapCenter = last.top + last.gap / 2;
Â  Â  Â  const safeMargin = 50;
Â  Â  Â  const minY = Math.max(60, gapCenter - last.gap / 2 + safeMargin);
Â  Â  Â  const maxY = Math.min(canvas.height - 80, gapCenter + last.gap / 2 - safeMargin);
Â  Â  Â  y = rnd(minY, maxY);
Â  Â  } else {
Â  Â  Â  y = rnd(100, canvas.height - 180);
Â  Â  }
Â  Â  items.push({ x, y, icon: type, type, collected: false });
Â  }
Â  
Â  // Ğ”Ğ²Ğ¸Ğ¶ĞµĞ½Ğ¸Ğµ Ñ‚Ñ€ÑƒĞ± Ğ¸ Ğ¿Ñ€ĞµĞ´Ğ¼ĞµÑ‚Ğ¾Ğ² (Ñ‚Ğ°ĞºĞ¶Ğµ ÑƒĞ¼Ğ½Ğ¾Ğ¶Ğ°ĞµĞ¼ Ğ½Ğ° dt_norm)
Â  const pipeSpeed = 3.2 * dt_norm; 
Â  pipes.forEach(p => (p.x -= pipeSpeed));
Â  items.forEach(i => (i.x -= pipeSpeed));
Â  
Â  pipes = pipes.filter(p => p.x > -70);
Â  items = items.filter(i => i.x > -40 && !i.collected);

Â  // ĞšĞ¾Ğ»Ğ»Ğ¸Ğ·Ğ¸Ğ¸
Â  pipes.forEach(p => {
Â  Â  const center = p.x + 30;
Â  Â  if (!p.passed && center < bird.x) { p.passed = true; score++; }
Â  Â  if (bird.x + bird.size > p.x && bird.x - bird.size < p.x + 60) {
Â  Â  Â  if (bird.y - bird.size < p.top || bird.y + bird.size > p.top + p.gap) {
Â  Â  Â  Â  if (shield) shield = false; else { play(sndWall); endGame(); }
Â  Â  Â  }
Â  Â  }
Â  });

Â  items.forEach(i => {
Â  Â  if (Math.abs(bird.x - i.x) < bird.size && Math.abs(bird.y - i.y) < bird.size) {
Â  Â  Â  if (i.type === 'ğŸ’£') { play(sndBomb); endGame(); }
Â  Â  Â  if (i.type === 'ğŸ’µ') { play(sndMoney); score += 3; }
Â  Â  Â  if (i.type === 'â¤ï¸') { play(sndHeart); shield = true; }
Â  Â  Â  i.collected = true;
Â  Â  }
Â  });
}
// ----------------------------------------------------

function drawHUD() {
Â  ctx.fillStyle = '#000';
Â  ctx.globalAlpha = 0.25; ctx.fillRect(10, 10, 180, 60); ctx.globalAlpha = 1;
Â  ctx.fillStyle = '#fff';
Â  ctx.font = '20px system-ui';
Â  ctx.textAlign = 'left'; ctx.textBaseline = 'alphabetic';
Â  ctx.fillText(`ĞÑ‡ĞºĞ¸: ${score}`, 20, 40);
Â  ctx.fillText(`Ğ›ÑƒÑ‡ÑˆĞ¸Ğ¹: ${best}`, 20, 65);
Â  if (shield) {
Â  Â  ctx.strokeStyle = 'rgba(255,0,0,0.5)';
Â  Â  ctx.lineWidth = 3; ctx.beginPath(); ctx.arc(bird.x, bird.y, bird.size * 1.5, 0, Math.PI * 2); ctx.stroke();
Â  }
}

function draw() {
  // ĞÑ‡Ğ¸ÑÑ‚ĞºĞ° ÑĞºÑ€Ğ°Ğ½Ğ° Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ° Ğ±Ñ‹Ñ‚ÑŒ Ğ² draw(), Ğ° Ğ½Ğµ Ğ² loop()
Â  ctx.clearRect(0, 0, canvas.width, canvas.height); 
Â  drawPipes();
Â  drawItems();
Â  drawCharacter();
Â  drawHUD();
Â  if (gameOver) {
Â  Â  ctx.fillStyle = 'rgba(0,0,0,0.6)';
Â  Â  const w = Math.min(380, canvas.width - 40);
Â  Â  const x = (canvas.width - w) / 2;
Â  Â  const y = canvas.height / 2 - 80;
Â  Â  ctx.fillRect(x, y, w, 160);
Â  Â  ctx.fillStyle = '#fff';
Â  Â  ctx.font = '28px system-ui';
Â  Â  ctx.textAlign = 'center';
Â  Â  ctx.fillText('Ğ˜Ğ³Ñ€Ğ° Ğ¾ĞºĞ¾Ğ½Ñ‡ĞµĞ½Ğ°', canvas.width / 2, y + 56);
Â  Â  ctx.font = '18px system-ui';
Â  Â  ctx.fillText('ĞĞ°Ğ¶Ğ¼Ğ¸ Ğ´Ğ»Ñ Ñ€ĞµÑÑ‚Ğ°Ñ€Ñ‚Ğ°', canvas.width / 2, y + 100);
Â  }
}

function endGame() { gameOver = true; best = Math.max(best, score); }

// ----------------------------------------------------
// Ğ“Ğ»Ğ°Ğ²Ğ½Ñ‹Ğ¹ Ğ¸Ğ³Ñ€Ğ¾Ğ²Ğ¾Ğ¹ Ñ†Ğ¸ĞºĞ» (Loop)
// ----------------------------------------------------
function loop() {
Â  const now = performance.now();
  // dt_ms = Ğ²Ñ€ĞµĞ¼Ñ Ğ² Ğ¼Ğ¸Ğ»Ğ»Ğ¸ÑĞµĞºÑƒĞ½Ğ´Ğ°Ñ…, Ğ¿Ñ€Ğ¾ÑˆĞµĞ´ÑˆĞµĞµ Ñ Ğ¿Ñ€Ğ¾ÑˆĞ»Ğ¾Ğ³Ğ¾ ĞºĞ°Ğ´Ñ€Ğ°
Â  const dt_ms = now - lastTime; 
Â  lastTime = now;

  // ĞĞ³Ñ€Ğ°Ğ½Ğ¸Ñ‡Ğ¸Ğ²Ğ°ĞµĞ¼ dt_ms, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¸Ğ·Ğ±ĞµĞ¶Ğ°Ñ‚ÑŒ "Ğ²Ğ·Ñ€Ñ‹Ğ²Ğ°" Ñ„Ğ¸Ğ·Ğ¸ĞºĞ¸,
  // ĞµÑĞ»Ğ¸ Ğ²ĞºĞ»Ğ°Ğ´ĞºĞ° Ğ±Ñ‹Ğ»Ğ° Ğ½ĞµĞ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ° (ÑĞ»Ğ¸ÑˆĞºĞ¾Ğ¼ Ğ±Ğ¾Ğ»ÑŒÑˆĞ¾Ğ¹ dt_ms)
Â  if (dt_ms < 1000) { 
Â  Â  update(dt_ms); 
Â  }
Â  
Â  draw();
Â  requestAnimationFrame(loop);
}
// ----------------------------------------------------

let interacted = false;
function primeAudio() {
Â  if (!interacted) { [sndJump,sndWall,sndBomb,sndMoney,sndHeart].forEach(s=>{ try{ s.play().then(()=>s.pause()).catch(()=>{}); }catch(_){} }); interacted = true; }
}

function play(snd){ if (interacted) { try { snd.currentTime = 0; snd.play(); } catch(_){} } }

function flap() {
Â  primeAudio();
Â  if (gameOver) {
Â  Â  gameOver = false; pipes = []; items = []; score = 0; bird.y = canvas.height * 0.5; bird.vy = 0; shield = false; 
Â  Â  // Ğ¡Ğ±Ñ€Ğ¾Ñ Ñ‚Ğ°Ğ¹Ğ¼ĞµÑ€Ğ¾Ğ² ÑĞ¿Ğ°ÑƒĞ½Ğ° Ğ¿Ñ€Ğ¸ Ñ€ĞµÑÑ‚Ğ°Ñ€Ñ‚Ğµ
Â  Â  pipeSpawnTimer = 0; itemSpawnTimer = 0; 
Â  Â  lastTime = performance.now(); // Ğ¡Ğ±Ñ€Ğ¾Ñ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¸Ğ·Ğ±ĞµĞ¶Ğ°Ñ‚ÑŒ Ğ±Ğ¾Ğ»ÑŒÑˆĞ¾Ğ³Ğ¾ dt Ğ² Ğ¿ĞµÑ€Ğ²Ğ¾Ğ¼ ĞºĞ°Ğ´Ñ€Ğµ
Â  Â  return;
Â  }
Â  play(sndJump);
  // ĞŸÑ€Ñ‹Ğ¶Ğ¾Ğº - ÑÑ‚Ğ¾ Ğ¼Ğ³Ğ½Ğ¾Ğ²ĞµĞ½Ğ½Ğ¾Ğµ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ ÑĞºĞ¾Ñ€Ğ¾ÑÑ‚Ğ¸, 
  // ĞµĞ³Ğ¾ Ğ½Ğµ Ğ½ÑƒĞ¶Ğ½Ğ¾ ÑƒĞ¼Ğ½Ğ¾Ğ¶Ğ°Ñ‚ÑŒ Ğ½Ğ° dt_norm.
Â  bird.vy = bird.lift; 
}
canvas.addEventListener('mousedown', flap);
canvas.addEventListener('touchstart', (e)=>{ e.preventDefault(); flap(); }, { passive:false });
window.addEventListener('keydown', (e)=>{ if (e.code === 'Space' || e.code === 'ArrowUp') { e.preventDefault(); flap(); } });

function rnd(min, max){ return Math.random() * (max - min) + min; }

// Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ğ¸Ğ³Ñ€Ğ¾Ğ²Ğ¾Ğ¹ Ñ†Ğ¸ĞºĞ»
loop();
</script>
